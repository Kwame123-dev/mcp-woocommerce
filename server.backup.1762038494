#!/usr/bin/env node
import express from 'express';
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { SSEServerTransport } from '@modelcontextprotocol/sdk/server/sse.js';

/* ---------- Minimal MCP server ---------- */
const server = new McpServer({
  name: 'african-creations-mcp',
  version: '1.0.0',
  instructions: 'Demo MCP server exposing search and fetch tools.'
});

/* ---------- TOOLS (correct schema + handler) ---------- */
// search tool: returns {results:[...]} as a JSON string in a text content item
server.tool(
  'search',
  {
    description: 'Search demo data',
    inputSchema: {
      type: 'object',
      properties: { query: { type: 'string' } }
    }
  },
  async ({ input }) => {
    const q = String(input?.query || '').toLowerCase();
    const corpus = [
      { id: 'demo-1', title: 'Bolga Basket Care Guide', url: 'https://example.com/bolga-care' },
      { id: 'demo-2', title: 'About African Creations', url: 'https://example.com/about' }
    ];
    const results = q ? corpus.filter(r => r.title.toLowerCase().includes(q)) : corpus;
    return { content: [{ type: 'text', text: JSON.stringify({ results }) }] };
  }
);

// fetch tool: returns a single document object as a JSON string in a text content item
server.tool(
  'fetch',
  {
    description: 'Fetch a demo document by id',
    inputSchema: {
      type: 'object',
      required: ['id'],
      properties: { id: { type: 'string' } }
    }
  },
  async ({ input }) => {
    const id = String(input.id);
    const doc =
      id === 'demo-1'
        ? {
            id,
            title: 'Bolga Basket Care Guide',
            text: 'Wipe with damp cloth; reshape with water; air-dry.',
            url: 'https://example.com/bolga-care',
            metadata: { source: 'demo' }
          }
        : {
            id,
            title: 'About African Creations',
            text: 'Ethically sourced Bolga baskets. Fair-trade, eco-focused.',
            url: 'https://example.com/about',
            metadata: { source: 'demo' }
          };
    return { content: [{ type: 'text', text: JSON.stringify(doc) }] };
  }
);

/* ---------- SSE endpoint ---------- */
const app = express();

app.get('/sse', async (req, res) => {
  console.log('ðŸ”Œ SSE connection received');
  const transport = new SSEServerTransport(req, res); // correct signature
  await server.connect(transport);
});

// tiny health check (optional)
app.get('/', (_req, res) => res.status(200).send('OK'));

/* ---------- Start HTTP with no timeouts ---------- */
const port = Number(process.env.PORT || 8787);
const srv = app.listen(port, () => {
  console.log(`âœ… MCP SSE running at http://localhost:${port}/sse`);
});
try {
  srv.keepAliveTimeout = 0;
  srv.headersTimeout = 0;
  srv.requestTimeout = 0;
} catch {}
